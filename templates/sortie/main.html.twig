{% extends 'base.html.twig' %}

{% block title %}{{ parent()}} | liste des sorties{% endblock %}

{% block body %}
    {# 0 . Inscruste de Max #}
    <div class="row m-5 text-center">
        <div class="col-4">
            <a href="{{ path('sortie_creer') }}" role="button" class="btn btn-primary">Créer une sortie</a>
        </div>
        <div class="col-4">
            <a href="{{ path('sortie_mes_sorties', {'pseudo': app.user.pseudo}) }}" role="button" class="btn btn-primary">Mes Sorties crées (TODO)</a>
        </div>
        <div class="col-4">
            <a href="#" role="button" class="btn btn-primary">Troisième bouton pour équilibrer</a>
        </div>
    </div>

{# I . Partie filtrage et recherche #}
<div>
    {{ form_start(form) }}
    {{ form_row(form.site) }}
    {{ form_row(form.name) }}
    {{ form_row(form.startDate) }}
    {{ form_row(form.endDate) }}
    {{ form_row(form.checkbox1) }}
    {{ form_row(form.checkbox2) }}
    {{ form_row(form.checkbox3) }}
    {{ form_row(form.checkbox4) }}
    <button type="submit">Filter</button>
    {{ form_end(form) }}
</div>

{# II . Partie affichage de la liste #}
<div >
    {# modification du titre en fonction de archive ou pas archive #}
    {% if form.vars.value %}
        {% set data = form.vars.value %}
        {% if data.checkbox4 %}
            <h1>Liste des sorties archivées</h1>
        {% else %}
            <h1>Liste des sorties prévues</h1>
        {% endif %}
    {% else %}
        <h1>Liste des sorties prévues</h1>
    {% endif %}

    {# affichage de la liste des events par site #}
    {% for site in sitesList %}
        {% set exist = 0 %}
        {% for sortie in sortiesList %}
            {% if site.nom == sortie.site.nom %}
                {% set exist = exist +1 %}
            {% endif %}
        {% endfor %}

        {% if exist >= 1 %}
            <table>
                <thead>
                <tr>
                    <th>{{ site.nom }}</th>
                </tr>
                </thead>
                <tbody>
                {% for sortie in sortiesList %}
                    {%  if sortie.site.id == site.id
                        and (sortie.dateHeureDebut) >= dateActuelle
                    %}
                        <tr>
                        <td>{{ sortie.nom }} : </td>
                        <td>{{ sortie.dateHeureDebut|date("d/m/Y - h:i") }}</td>
                        <td>{{ sortie.dateLimiteInscription|date("d/m/Y") }}</td>
                        {% set inscCount = 0 %}
                        {% set myInsc = '' %}
                        {% for inscription in inscriptionsList %}
                            {% if inscription.sortie.id == sortie.id %}
                                {% set inscCount = inscCount + 1 %}
                                {% if inscription.participant.id == app.user.id %}
                                    {% set myInsc = 'X' %}
                                {% endif %}
                            {% endif %}
                        {%  endfor %}
                        <td>{{ inscCount }}/{{ sortie.nbInscriptionsMax }}</td>
                        <td>{{ sortie.etat.libelle }}</td>
                            {# comparaison dans al table inscription pour vérifier si l'ID en session correspond à un inscrit à cet event #}
                        <td>{{ myInsc }}</td>
                        <td>{{ sortie.organisateur.pseudo }}</td>
                        <td><a href="{{ path('sortie_detail', {'id':sortie.id}) }}" title="détail de la sortie">Afficher</a></td>
                        {% if sortie.etat.id == 2 %}
                            {% if myInsc =="X" %}
                                <td><a href="#" title="se désister">Me retirer</a></td>
                            {% else %}
                                <td><a href="#" title="s'inscrire">M'inscrire</a></td>
                            {% endif %}
                        {% endif %}
                        </tr>
                    {% endif %}
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
        <br>
    {% endfor %}
    <br>
</div>
{% endblock %}
